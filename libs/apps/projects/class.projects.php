<?php
class Projects {

	protected $_system;
	protected $_pgError;

	public function __construct(){
		$this->_system = System::singleton();
		set_error_handler(array($this, 'exception_error_handler'));
	}

	protected function exception_error_handler($errno, $errstr, $errfile, $errline ) {
		throw new ErrorException($errstr, $errno, 0, $errfile, $errline);
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                      GET 	                  ******************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	public function getProjectInfo($project_id){
		$query 		= "SELECT * FROM projects WHERE id='".$project_id."'";

		//echo $query;
		$rs 		= $this->_system->pdo_select("bd1",$query);
		if(count($rs)===1){
			if($rs[0]['status']===1){
				if($rs[0]['use_tiled_background']){
					$tiledInfo  = $this->getTiledInfo($rs[0]['selected_tiled']);
					$rs[0]['tiled'] = $tiledInfo['message'];
				}

				$bgInfo = $this->getBackgroundInfo($rs[0]['background']);
				$rs[0]['bgInfo'] = $bgInfo['message'];

				if($rs[0]['use_double_background']){
					$tiledInfo  = $this->getBackgroundInfo($rs[0]['second_background']);
					$rs[0]['bgInfo_secondary'] = $tiledInfo['message'];
				}
				if((int)$rs[0]['use_area_of_interest']===1){
					//Get user extent
					require_once __DIR__.'/class.extent.php';
	        $_ext = new Extent();
	        $req = $_ext->getExtent();
					if($req['status']==="Accepted"){
						if($req['message']['geometry']){
							$rs[0]['extent'] = $req['message']['geometry'];
              $rs[0]['extent_filter'] = (array_key_exists('tiled_filter',$req['message'])) ? $req['message']['tiled_filter']: null;
						}
					}
				}
				return array("status"=>"Accepted","message"=>$rs[0],"code"=>200);
			}else{
				return array("status"=>"Failed","message"=>"Project is not active","code"=>000);
			}
		}else{
			return array("status"=>"Failed","message"=>"Project not found","code"=>404);
		}
	}

	public function getUserProjectPermissions($project_id,$user_id){
		
	}

	protected function _getLayerInfo($layer){
		
	}

	protected function _getGeometryName($layerInfo){
	
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                     END GET 	                ****************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                    IMAGES	                    ****************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	protected function _addImageToPg($layer,$feature_id,$photo_id){
		
	}


	public function readImage($id){
		

	}

	public function removeImg($datos){

	}

	protected function _reomveImageFromPg($layer,$feature_id,$photo_id){
		
	}

	protected function _removeAllPhotos($feature_id,$layer){
	
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                 END IMAGES	                    ****************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                 UPDATE/DELETE	                ****************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	public function addGeometry($data,$layer,$epsg,$geometry,$tableIdName){
		
	}

	public function updateFeature($data,$id,$epsg,$layer,$tableIdName,$geometry){
		
	}

	public function removeFeature($id,$layer,$tableIdName){
		
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                END UPDATE/DELETE	             ***************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	 //**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                      FORM INFO	              ******************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	public function getFormData(){}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                      END FORM INFO	           *****************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                     BACKGROUNDS                  ***************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	public function getBackgroundInfo($bg_id){

	}

	public function getBackgrounds(){

	}

	public function getProjectBackgrounds($project_id){
		
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                  END BACKGROUNDS                 ***************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                        TILED                     ***************************
	//**********************************************************************************************************
	//**********************************************************************************************************


	public function getTiledInfo($tiledId){

	}

	public function getTiled(){

	}

	public function getProjectTiled($project_id){
		
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                    END TILED                     ***************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                    HELPERS 	                  ******************************
	//**********************************************************************************************************
	//**********************************************************************************************************

	protected function _pgConnect($db_host,$db_name,$user_db,$pwd_db,$db_port=null){
		try {
			if($db_port){
				$dbconn = @pg_connect("host=".$db_host." port=".$db_port." dbname=".$db_name." user=".$user_db." password=".$pwd_db."");
			}else{
				$dbconn = @pg_connect("host=".$db_host." dbname=".$db_name." user=".$user_db." password=".$pwd_db."");
			}
			return array("status"=>"Accepted","message"=>$dbconn);
		} Catch (Exception $e) {
			return array("status"=>"Failed","message"=>$e->getMessage());
		}
	}

	protected function _decryptData($value,$key){
	
	}

	//**********************************************************************************************************
	//**********************************************************************************************************
	//*****************************                   END HELPERS 	                 ***************************
	//**********************************************************************************************************
	//**********************************************************************************************************
}
